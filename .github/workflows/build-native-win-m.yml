name: build-native-win-only

on:
  workflow_dispatch:

jobs:
  native-win:
    runs-on: windows-latest

    env:
      NODE_VERSION: "16.14.2"
      ELECTRON_VERSION: "15.5.7"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: yarn

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Ensure MSVC build tools available
        shell: pwsh
        run: |
          # 显示 runner 上已安装的 VS（用于排查）
          & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -all -prerelease -products * -format json


      - name: Install deps
        run: |
          yarn install --frozen-lockfile

      - name: Install Windows 11 SDK
        shell: pwsh
        run: |
          choco install -y windows-sdk-11-version-22h2-all

      - name: Verify Windows SDK
        shell: pwsh
        run: |
          Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\Lib" -ErrorAction SilentlyContinue | Select-Object -First 5

      # 对 Electron 15.5.7 重编译原生模块（逐个模块）
      - name: Rebuild 5 native modules for Electron (from source)
        shell: cmd
        env:
          npm_config_runtime: electron
          npm_config_target: 15.5.7
          npm_config_disturl: https://electronjs.org/headers
          npm_config_build_from_source: "true"
          GYP_MSVS_VERSION: "2022"
        run: |
          for /f "usebackq delims=" %%i in (`"%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath`) do set "VSINSTALL=%%i"
          call "%VSINSTALL%\VC\Auxiliary\Build\vcvars64.bat"

          yarn add drivelist@9.2.4 --verbose

          yarn add native-keymap@2.5.0 --verbose

          yarn add keytar@7.2.0 --verbose

          yarn add node-pty@0.11.0-beta17 --verbose

          yarn add nsfw@2.2.4 --verbose



      # 打包成 artifact：把这5个模块的整个目录上传（最省事）
      # 里面会包含 build/Release/*.node 等产物
      - name: Upload compiled native modules (win)
        uses: actions/upload-artifact@v4
        with:
          name: native-modules-win-electron-15.5.7
          path: |
            node_modules/drivelist/**
            node_modules/native-keymap/**
            node_modules/keytar/**
            node_modules/node-pty/**
            node_modules/nsfw/**
          if-no-files-found: error
